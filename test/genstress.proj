<Project ToolsVersion="12.0" DefaultTargets="BuildAndTest" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Import Project=".\dir.props" />

  <PropertyGroup>
    <BuildMoniker Condition="'$(BuildMoniker)' == ''">$(USERNAME)-$([System.DateTime]::Now.ToString(MMdd-hhmmss))</BuildMoniker>
  </PropertyGroup>
  
   <!--
    Stress suite generation properties
   -->
  <PropertyGroup>
    <SuiteName Condition="'$(SuiteName)' == ''">$(BuildMoniker)</SuiteName>
    <SuiteConfig Condition="'$(SuiteConfig)' == ''">smoketest.suite.json</SuiteConfig>
    <SuiteConfigPath Condition="'$(SuiteConfigPath)' == ''">$(MSBuildThisFileDirectory)suiteconfig\$(SuiteConfig)</SuiteConfigPath>
    <SuitePath Condition="'$(SuitePath)' == ''">$(MSBuildThisFileDirectory)generated\</SuitePath>
    <DiscoveryCachePath Condition="'$(DiscoveryCachePath)'==''">$(BaseIntermediateOutputPath)testdiscoverycache.json</DiscoveryCachePath>
  </PropertyGroup>
  
  <!--
    Build input properties
    Define where we get product / test binaries and how we discover test binaries
    This will probably change when we merge into the orchestrated build process
    for now we will put them at the root in a 'ext' folder
  -->
  <PropertyGroup>
    <UnitTestFileMask Condition="'$(UnitTestDirectory)' == ''">*.Tests.dll</UnitTestFileMask>
    <UnitTestDirectory Condition="'$(UnitTestDirectory)' == ''">$(MSBuildThisFileDirectory)..\ext\tests\</UnitTestDirectory>
    <ProductPackageDirectory Condition="'$(ProductPackageDirectory)' == ''">$(MSBuildThisFileDirectory)..\ext\packages\</ProductPackageDirectory>
    <ProductBinDirectory Condition="'$(ProductBinDirectory)' == ''">$(MSBuildThisFileDirectory)..\ext\bin\</ProductBinDirectory>
  </PropertyGroup>
  
  <!-- 
    Stress tooling locations
    get stress.codegen and stress.execution from the bin directory (using the latest built version) 
    it's possible that this should be changed to use packages to allow development 
    without affecting runs
  -->
  <PropertyGroup>
    <StressCodegenAssmPath>$(BinDir)AnyOS.AnyCPU.Debug\stress.codegen\stress.codegen.dll</StressCodegenAssmPath>
    <StressExecAssmPath>$(BinDir)AnyOS.AnyCPU.Debug\stress.codegen\stress.execution.dll</StressExecAssmPath>
  </PropertyGroup>

  <Import Project="..\dir.targets" />

  <Import Project="..\dir.traversal.targets" />
  
  <UsingTask TaskName="GenerateStressSuiteTask" AssemblyFile="$(StressCodegenAssmPath)"/>

  <Target Name="Build">

    <Message Text="Generating stress test sources..." Importance="High" />
    
    <GenerateStressSuiteTask
      SuiteName="$(SuiteName)"
      DebugWaitForInput="$(DebugStress)"
      SuitePath="$(SuitePath)"
      DiscoveryCachePath="$(DiscoveryCachePath)"
      ConfigPath="$(SuiteConfigPath)"
      TestPaths="$(UnitTestDirectory)"
      TestSearchStrings="$(UnitTestFileMask)"
      FrameworkPaths="$(ProductBinDirectory)"/>
  </Target>
  
</Project>