<Project ToolsVersion="12.0" DefaultTargets="BuildAndTest" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Import Project=".\dir.props" />

  <PropertyGroup>
    <BuildMoniker Condition="'$(BuildMoniker)' == ''">$(USERNAME)-$([System.DateTime]::Now.ToString(MMdd-hhmmss))</BuildMoniker>
  </PropertyGroup>
  
   <!--
    Stress suite generation properties
   -->
  <PropertyGroup>
    <SuiteName Condition="'$(SuiteName)' == ''">$(BuildMoniker)</SuiteName>
    <SuiteConfig Condition="'$(SuiteConfig)' == ''">smoketest.suite.json</SuiteConfig>
    <SuiteConfigPath Condition="'$(SuiteConfigPath)' == ''">$(MSBuildThisFileDirectory)suiteconfig\$(SuiteConfig)</SuiteConfigPath>
    <SuitePath Condition="'$(SuitePath)' == ''">$(MSBuildThisFileDirectory)generated\</SuitePath>
    <DiscoveryCachePath Condition="'$(DiscoveryCachePath)'==''">$(BaseIntermediateOutputPath)testdiscoverycache.json</DiscoveryCachePath>
  </PropertyGroup>
  
  <!--
    Build input properties
    Define where we get product / test binaries and how we discover test binaries
    This will probably change when we merge into the orchestrated build process
    for now we will put them at the root in a 'ext' folder
  -->
  <PropertyGroup>
    <UnitTestFileMask Condition="'$(UnitTestDirectory)' == ''">*.Tests.dll</UnitTestFileMask>
    <UnitTestDirectory Condition="'$(UnitTestDirectory)' == ''">$(MSBuildThisFileDirectory)unittests\</UnitTestDirectory>
    <UnitTestExtractedSemaphore Condition="'$(UnitTestExtractedSemaphore)' == ''">$(UnitTestDirectory)extracted</UnitTestExtractedSemaphore>
  </PropertyGroup>
  
  <!-- 
    Stress tooling locations
    get stress.codegen and stress.execution from the bin directory (using the latest built version) 
    it's possible that this should be changed to use packages to allow development 
    without affecting runs
  -->
  <PropertyGroup>
    <StressCodegenAssmPath>$(BinDir)AnyOS.AnyCPU.Debug\stress.codegen\stress.codegen.dll</StressCodegenAssmPath>
    <StressExecAssmPath>$(BinDir)AnyOS.AnyCPU.Debug\stress.codegen\stress.execution.dll</StressExecAssmPath>
  </PropertyGroup>
  <PropertyGroup>
    <UnitTestCLIProjDir>$(BaseIntermediateOutputPath)utcli\</UnitTestCLIProjDir>
    <UnitTestCLIProjJson>$(UnitTestCLIProjDir)project.json</UnitTestCLIProjJson>
    <UnitTestPackageDir>$(BaseIntermediateOutputPath)utpackage</UnitTestPackageDir>
    <UnitTestDependsBin>$(BaseIntermediateOutputPath)utdepends</UnitTestDependsBin>
    <TestDependRestoreCommand>$(DotnetToolCommand) restore --packages "$(UnitTestPackageDir.TrimEnd('/\'.ToCharArray()))" $(DnuRestoreSource)</TestDependRestoreCommand>
    <TestDependPublishCommand>$(DotnetToolCommand) publish --output "$(UnitTestDependsBin.TrimEnd('/\'.ToCharArray()))" --runtime win7-x64</TestDependPublishCommand>
  </PropertyGroup>
  
  <Import Project="..\dir.targets" />

  <Import Project="..\dir.traversal.targets" />
  
  <UsingTask TaskName="MergeAllProjectJsonsTask" AssemblyFile="$(StressCodegenAssmPath)"/>
  <UsingTask TaskName="GenerateStressSuiteTask" AssemblyFile="$(StressCodegenAssmPath)"/>
  <UsingTask TaskName="ZipFileExtractToDirectory" AssemblyFile="$(BuildToolsTaskDir)Microsoft.DotNet.Build.Tasks.dll"/>

  <ItemGroup>
    <ZipFile Include="$(UnitTestDirectory)**\*.zip"/>
  </ItemGroup>
 
 <Target Name="UnzipAllTests" 
    Condition="!Exists('$(UnitTestExtractedSemaphore)')"
    DependsOnTargets="UnzipTest">
    <WriteLinesToFile File="$(UnitTestExtractedSemaphore)" Lines="" Overwrite="false" />
  </Target>
 
 <Target Name="UnzipTest"
    Inputs="@(ZipFile)"
    Outputs="%(RootDir)%(Directory)%(ZipFile.FileName)">

    <ZipFileExtractToDirectory Condition="!Exists('%(RootDir)%(Directory)%(ZipFile.FileName)')"
        SourceArchive="%(ZipFile.FullPath)"
        DestinationDirectory="%(RootDir)%(Directory)%(ZipFile.FileName)"
        OverwriteDestination="true" />
  </Target>
  
  <Target Name="RestoreTestDependsBin" DependsOnTargets="UnzipAllTests">
    <Message Text="Restoring test dependencies..." />
    
    <RemoveDir Directories="$(UnitTestCLIProjDir)" />
    <RemoveDir Directories="$(UnitTestPackageDir)" />
    <RemoveDir Directories="$(UnitTestDependsBin)" />
    
    <!-- create a dummy project used to restore test binaries -->
    <MakeDir Directories="$(UnitTestCLIProjDir)"/>
    <Exec Command="$(DotnetToolCommand) new" StandardOutputImportance="Low" CustomErrorRegularExpression="^Unable to locate .*" WorkingDirectory="$(UnitTestCLIProjDir)"/>

    <!-- delete the dummy project.json and replace with merged project json from the unit test drop -->
    <Delete Files="$(UnitTestCLIProjJson)" />
    <MergeAllProjectJsonsTask 
        InPath="$(UnitTestDirectory)" 
        OutPath="$(UnitTestCLIProjJson)"
        Debug="$(DebugMergeProjectJson)"/>
    
    <!-- restore and publish the dummy project to get a flat  -->
    <Exec Command="$(TestDependRestoreCommand)" StandardOutputImportance="Low" CustomErrorRegularExpression="^Unable to locate .*" WorkingDirectory="$(UnitTestCLIProjDir)"/>
    <Exec Command="$(TestDependPublishCommand)" StandardOutputImportance="Low" CustomErrorRegularExpression="^Unable to locate .*" WorkingDirectory="$(UnitTestCLIProjDir)"/>
  </Target>

  
  <Target Name="Build" DependsOnTargets="RestoreTestDependsBin">
 
    <Error Condition="!Exists('$(SuiteConfigPath)')" Text="ERROR: File not found. Stress suite config path '$(SuiteConfigPath)' is invalid " />

    <MakeDir Directories="$(StressGeneratedRoot)"/>
    
    <Message Text="Generating stress test sources..." Importance="High" />
    
    <GenerateStressSuiteTask
      SuiteName="$(SuiteName)"
      DebugWaitForInput="$(DebugStress)"
      SuitePath="$(SuitePath)"
      DiscoveryCachePath="$(DiscoveryCachePath)"
      ConfigPath="$(SuiteConfigPath)"
      TestPaths="$(UnitTestDirectory)"
      TestSearchStrings="$(UnitTestFileMask)"
      FrameworkPaths="$(UnitTestDependsBin)"/>
  </Target>

  <Target Name="Clean">
    
    <Message Text="Cleaning generated source directory..." />
    
    <RemoveDir Directories="$(SuitePath)" />
   
    <RemoveDir Directories="$(UnitTestCLIProjDir)" />
  </Target>

</Project>